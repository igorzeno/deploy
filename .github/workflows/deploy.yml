name: Deploy
on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Generate .env from template
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          echo "üîß Generating .env from template..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —à–∞–±–ª–æ–Ω–∞
          if [ ! -f ".env.production.template" ]; then
            echo "‚ùå Template not found! Creating minimal one..."
            cat > .env.production.template << "EOF"
          APP_NAME="My App Deploy"
          APP_KEY=${APP_KEY}
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=http://${SSH_HOST}:8080
          
          DB_CONNECTION=mysql
          DB_HOST=db
          DB_PORT=3306
          DB_DATABASE=laravel
          DB_USERNAME=root
          DB_PASSWORD=${DB_PASSWORD}
          EOF
            fi
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env
            envsubst < .env.production.template > .env
            
            echo "‚úÖ .env generated"
            echo "üìã Preview:"
            head -8 .env
          
          - name: Deploy via SSH
            uses: appleboy/ssh-action@v0.1.5
            with:
              host: ${{ secrets.SSH_HOST }}
              username: ${{ secrets.SSH_USERNAME }}
              port: ${{ secrets.SSH_PORT }}
              key: ${{ secrets.SSH_PRIVATE_KEY }}
              script: |
                cd /var/www
                
                # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –ø—É—Å—Ç–∞—è - –∫–ª–æ–Ω–∏—Ä—É–µ–º
                if [ ! -d ".git" ]; then
                  echo "üì• Cloning repository..."
                  git clone https://github.com/igorzeno/deploy.git .
                fi
                
                echo "üì• Pulling latest changes..."
                git pull origin master 
                
                echo "=== 1. FIX STORAGE ==="
                sudo rm -rf storage bootstrap/cache 2>/dev/null || true
                sudo mkdir -p storage/framework/{sessions,views,cache}
                sudo mkdir -p storage/logs bootstrap/cache
                sudo chmod -R 777 storage bootstrap/cache
                
                echo "=== 2. COPY GENERATED .ENV ==="
                cat > .env << 'EOF'
            $(cat .env)
            EOF
            
            echo "‚úÖ .env created"
            echo "üìÑ First 3 lines:"
            head -3 .env
            
            echo "=== 3. START DOCKER ==="
            docker-compose down || true
            docker-compose up -d --build
            
            echo "=== 4. HEALTH CHECK ==="
            sleep 3
            
            
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Docker..."
            cd /var/www/app
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä composer
            docker run --rm -v $(pwd):/app -w /app composer:latest \
              composer install --no-dev --optimize-autoloader --no-scripts 2>&1
            
            if [ -d "vendor" ]; then
              echo "‚úÖ Vendor —Å–æ–∑–¥–∞–Ω!"
              ls -la vendor/ | head -3
            else
              echo "‚ùå Vendor –Ω–µ —Å–æ–∑–¥–∞–Ω!"
              exit 1
            fi
            
            cd /var/www
            
            # 1. Build app
            docker-compose -f docker-compose.prod.yml build app
            
            # 2. Start DB only
            docker-compose -f docker-compose.prod.yml up -d db
            sleep 25
            
            # 3. –í–°–ï –∫–æ–º–∞–Ω–¥—ã –≤ –û–î–ù–û–ú run
            docker-compose -f docker-compose.prod.yml run --rm app sh -c "
            php artisan migrate:refresh --force
            php artisan db:seed --force
            "
            
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "‚úÖ Done!"