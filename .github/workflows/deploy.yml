name: Deploy
on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Generate .env from template
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          echo "üîß Generating .env from template..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —à–∞–±–ª–æ–Ω–∞
           run: |
            if [ ! -f ".env.production.template" ]; then
            echo "‚ùå Template not found! Creating minimal one..."
            cat > .env.production.template << "EOF"
          APP_NAME="My App Deploy"
          APP_KEY=${APP_KEY}          # ‚Üê –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=http://${SSH_HOST}:8080  # ‚Üê –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!
          
          DB_CONNECTION=mysql
          DB_HOST=db
          DB_PORT=3306
          DB_DATABASE=laravel
          DB_USERNAME=root
          DB_PASSWORD=${DB_PASSWORD}  # ‚Üê –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!
          EOF
          fi
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env
          envsubst < .env.production.template > .env
          
          echo "‚úÖ .env generated"
          echo "üìã Preview:"
          head -10 .env

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www

            # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –ø—É—Å—Ç–∞—è - –∫–ª–æ–Ω–∏—Ä—É–µ–º
            if [ ! -d ".git" ]; then
              echo "üì• Cloning repository..."
              git clone https://github.com/igorzeno/deploy.git .
            fi
            
            echo "üì• Pulling latest changes..."
            git pull origin master 

            echo "=== 1. FIX STORAGE ONCE AND FOR ALL ==="
            sudo rm -rf storage bootstrap/cache 2>/dev/null || true
            
            sudo mkdir -p storage
            sudo mkdir -p storage/framework
            sudo mkdir -p storage/framework/sessions
            sudo mkdir -p storage/framework/views
            sudo mkdir -p storage/framework/cache
            sudo mkdir -p storage/logs
            sudo mkdir -p bootstrap
            sudo mkdir -p bootstrap/cache
            
            sudo chmod -R 777 storage bootstrap/cache
            
            echo "=== 2. COPY GENERATED .ENV ==="
            # –ö–æ–ø–∏—Ä—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π .env —Å GitHub Actions runner
            cat > .env << 'EOF'
            $(cat .env)
            EOF
            
            echo "‚úÖ .env created from template"
            echo "üìÑ First 5 lines:"
            head -5 .env

            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Docker..."
            cd /var/www/app
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä composer
            docker run --rm -v $(pwd):/app -w /app composer:latest \
              composer install --no-dev --optimize-autoloader --no-scripts 2>&1
            
            if [ -d "vendor" ]; then
              echo "‚úÖ Vendor —Å–æ–∑–¥–∞–Ω!"
              ls -la vendor/ | head -3
            else
              echo "‚ùå Vendor –Ω–µ —Å–æ–∑–¥–∞–Ω!"
              exit 1
            fi
            
            cd /var/www
            
            # 1. Build app
            docker-compose -f docker-compose.prod.yml build app
            
            # 2. Start DB only
            docker-compose -f docker-compose.prod.yml up -d db
            sleep 25
            
            # 3. –í–°–ï –∫–æ–º–∞–Ω–¥—ã –≤ –û–î–ù–û–ú run
            docker-compose -f docker-compose.prod.yml run --rm app sh -c "
            php artisan migrate:refresh --force
            php artisan db:seed --force
            "
            
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "‚úÖ Done!"